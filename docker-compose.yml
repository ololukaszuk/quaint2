services:

  # TimescaleDB with pg_cron - Time-series database for cryptocurrency data
  timescaledb:
    build:
      context: .
      dockerfile: timescaledb/Dockerfile
    container_name: btc-ml-timescaledb
    environment:
      - POSTGRES_DB=btc_ml_production
      - POSTGRES_USER=mltrader
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_HOST_AUTH_METHOD=scram-sha-256
    ports:
      - "${DB_PORT:-5432}:5432"
    volumes:
      - timescaledb_data:/var/lib/postgresql/data
      - ./timescaledb/init.sql:/docker-entrypoint-initdb.d/01-init.sql
      - ./ml-layer-1/migrations/001_ml_tables.sql:/docker-entrypoint-initdb.d/02-ml-tables.sql
      - ./market-analyzer/migrations/001_market_analyzer_tables.sql:/docker-entrypoint-initdb.d/03-market-analyzer.sql
      - ./market-analyzer/migrations/002_enhanced_schema.sql:/docker-entrypoint-initdb.d/04-market-analyzer-enhancements.sql
      - ./llm-analyst/migrations/001_llm_analyst_tables.sql:/docker-entrypoint-initdb.d/05-llm-analyst.sql
      - ./llm-analyst/migrations/002_llm_analyst_enhanced.sql:/docker-entrypoint-initdb.d/06-llm-analyst-enhancements.sql
      - ./market-analyzer/migrations/003_complete_pivots.sql:/docker-entrypoint-initdb.d/07-market-analyzer-complete-pivots.sql
      - ./market-analyzer/migrations/004_llm_requests.sql:/docker-entrypoint-initdb.d/08-llm-requests.sql
    command: >
      postgres
      -c shared_preload_libraries=timescaledb,pg_cron
      -c cron.database_name=btc_ml_production
      -c max_connections=200
      -c shared_buffers=256MB
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mltrader -d btc_ml_production"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - btc-ml-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"

  # Rust Data Feeder - Real-time price ingestion from Binance
  data-feeder:
    build:
      context: .
      dockerfile: data-feeder/Dockerfile
    container_name: btc-ml-feeder
    environment:
      - BINANCE_STREAM_URL=${BINANCE_STREAM_URL:-wss://stream.binance.com:9443/ws}
      - DB_HOST=timescaledb
      - DB_PORT=5432
      - DB_NAME=btc_ml_production
      - DB_USER=mltrader
      - DB_PASSWORD=${DB_PASSWORD}
      - FEATURE_UPDATE_INTERVAL=60
      - GAP_DETECTION_THRESHOLD=70
      - GAP_HANDLER_URL=http://gap-handler:9000/backfill
      - HEALTH_CHECK_PORT=8080
      - LOG_LEVEL=${LOG_LEVEL:-info}
    ports:
      - "${FEEDER_PORT:-8080}:8080"
    depends_on:
      timescaledb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      - btc-ml-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"

  # Go Gap Handler - Backfill missing candles from Binance REST API
  gap-handler:
    build:
      context: .
      dockerfile: gap-handler/Dockerfile
    container_name: btc-ml-gap-handler
    environment:
      - DB_HOST=timescaledb
      - DB_PORT=5432
      - DB_NAME=btc_ml_production
      - DB_USER=mltrader
      - DB_PASSWORD=${DB_PASSWORD}
      - BINANCE_API_URL=https://api.binance.com
      - GAP_HANDLER_PORT=9000
      - MAX_CONCURRENT_BACKFILLS=5
      - BACKFILL_TIMEOUT_SECONDS=300
      - LOG_LEVEL=${LOG_LEVEL:-info}
    ports:
      - "${GAP_HANDLER_PORT:-9000}:9000"
    depends_on:
      timescaledb:
        condition: service_healthy
      data-feeder:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-fsS",  "http://localhost:9000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      - btc-ml-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"

  # pgAdmin4 - PostgreSQL web management interface
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: btc-ml-pgadmin
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@example.com
      - PGADMIN_DEFAULT_PASSWORD=${PGADMIN_PASSWORD:-admin}
      - SCRIPT_NAME=/pgadmin4
    ports:
      - "${PGADMIN_PORT:-8000}:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
      - ./pgadmin/servers.json:/pgadmin4/servers.json:ro
      - ./pgadmin/entrypoint.sh:/custom-entrypoint.sh:ro
    depends_on:
      timescaledb:
        condition: service_healthy
    networks:
      - btc-ml-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"

   # ============================================================================
   # ML Layer 1 - Inference Service (real-time predictions â†’ DB)
   # ============================================================================

  ml-inference:
    build:
      context: ./ml-layer-1
      dockerfile: inference/Dockerfile
    container_name: btc-ml-inference
    runtime: nvidia
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    environment:
      - DB_HOST=timescaledb
      - DB_PORT=5432
      - DB_NAME=btc_ml_production
      - DB_USER=mltrader
      - DB_PASSWORD=${DB_PASSWORD}
      - ML_MODEL_PATH=${ML_MODEL_PATH:-/app/models/lstm_btc.onnx}
      - ML_NORM_PATH=${ML_NORM_PATH:-/app/models/normalization_params.json}
      - CUDA_VISIBLE_DEVICES=${CUDA_VISIBLE_DEVICES:-0}
      - ORT_TENSORRT_FP16_ENABLE=${ORT_TENSORRT_FP16_ENABLE:-1}
      - RUST_LOG=${LOG_LEVEL:-info}
    volumes:
      - ./ml-layer-1/models:/app/models:ro
    depends_on:
      timescaledb:
        condition: service_healthy
    networks:
      - btc-ml-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"

  # ============================================================================
  # ML Layer 1 - Training Service (on-demand model training)
  # ============================================================================

  ml-training:
    build:
      context: ./ml-layer-1/training
      dockerfile: Dockerfile
    container_name: btc-ml-training
    profiles:
      - training
    runtime: nvidia
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    environment:
      - DB_HOST=timescaledb
      - DB_PORT=5432
      - DB_NAME=btc_ml_production
      - DB_USER=mltrader
      - DB_PASSWORD=${DB_PASSWORD}
      - ML_MODELS_DIR=${ML_MODELS_DIR:-/app/models}
      - CUDA_VISIBLE_DEVICES=${CUDA_VISIBLE_DEVICES:-0}
      - PYTHONUNBUFFERED=1
    volumes:
      - ./ml-layer-1/models:/app/models:rw
    depends_on:
      timescaledb:
        condition: service_healthy
    networks:
      - btc-ml-network
    command: python3 train.py
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"
 
  # ============================================================================
  # Data WebSocket Service (streams predictions from DB)
  # ============================================================================
  data-ws:
    build:
      context: ./data-ws
      dockerfile: Dockerfile
    container_name: btc-data-ws
    environment:
      - DB_HOST=timescaledb
      - DB_PORT=5432
      - DB_NAME=btc_ml_production
      - DB_USER=mltrader
      - DB_PASSWORD=${DB_PASSWORD}
      - DATA_WS_BIND_ADDR=0.0.0.0:8443
      - API_KEY=${DATA_WS_API_KEY}
      - RUST_LOG=${LOG_LEVEL:-info}
    ports:
      - "${DATA_WS_PORT:-8443}:8443"
    depends_on:
      timescaledb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-fk", "https://localhost:8443/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - btc-ml-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"

  # ============================================================================
  # Market Analyzer - Real-time market context analysis
  # ============================================================================
  market-analyzer:
    build:
      context: ./market-analyzer
      dockerfile: Dockerfile
    container_name: btc-ml-market-analyzer
    environment:
      - DB_HOST=timescaledb
      - DB_PORT=5432
      - DB_NAME=btc_ml_production
      - DB_USER=mltrader
      - DB_PASSWORD=${DB_PASSWORD}
      - POLL_INTERVAL=${ANALYZER_POLL_INTERVAL:-5}
      - LOOKBACK_CANDLES=${ANALYZER_LOOKBACK_CANDLES:-300000}
      - HEALTH_PORT=8082
      - LLM_REQUESTS_ENABLED=${LLM_REQUESTS_ENABLED:-true}
      - DETAILED_LOGGING=${DETAILED_LOGGING:-false}
    ports:
      - "${ANALYZER_PORT:-8082}:8082"
    depends_on:
      timescaledb:
        condition: service_healthy
      data-feeder:
        condition: service_started
    networks:
      - btc-ml-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"

  # ============================================================================
  # LLM Analyst - AI-powered market commentary using Ollama/DeepSeek
  # ============================================================================
  llm-analyst:
    build:
      context: ./llm-analyst
      dockerfile: Dockerfile
    container_name: btc-ml-llm-analyst
    environment:
      - DB_HOST=timescaledb
      - DB_PORT=5432
      - DB_NAME=btc_ml_production
      - DB_USER=mltrader
      - DB_PASSWORD=${DB_PASSWORD}
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://localhost:11434}
      - OLLAMA_MODEL=${OLLAMA_MODEL:-deepseek-r1:32b}
      - OLLAMA_TIMEOUT=${OLLAMA_TIMEOUT:-300}
      - ANALYSIS_INTERVAL_CANDLES=${LLM_ANALYSIS_INTERVAL:-5}
      - CANDLES_1H_LOOKBACK=${LLM_CANDLES_1H_LOOKBACK:-120}
      - CANDLES_15M_LOOKBACK=${LLM_CANDLES_15M_LOOKBACK:-20}
      - SIGNAL_HISTORY_COUNT=${LLM_SIGNAL_HISTORY:-15}
      - POLL_INTERVAL=${LLM_POLL_INTERVAL:-10}
      - HEALTH_PORT=8083
      - DETAILED_LOGGING=${DETAILED_LOGGING:-false}
    ports:
      - "${LLM_ANALYST_PORT:-8083}:8083"
    depends_on:
      timescaledb:
        condition: service_healthy
      market-analyzer:
        condition: service_started
    networks:
      - btc-ml-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"

  # ============================================================================
  # Data API - Secure REST API for accessing trading data (HTTPS)
  # ============================================================================
  data-api:
    build:
      context: ./data-api
      dockerfile: Dockerfile
    container_name: btc-ml-data-api
    environment:
      - DATABASE_URL=postgresql://mltrader:${DB_PASSWORD}@timescaledb:5432/btc_ml_production
      - API_KEY=${DATA_API_KEY}
      - USE_TLS=${DATA_API_USE_TLS:-true}
      - PORT=8443
      - TLS_CERT_FILE=${DATA_API_TLS_CERT_FILE:-/certs/server.crt}
      - TLS_KEY_FILE=${DATA_API_TLS_KEY_FILE:-/certs/server.key}
    ports:
      - "${DATA_API_PORT:-8443}:8443"
    #volumes:
      # Optional: mount custom certificates (uncomment for production)
      # - ./certs:/certs:ro
    depends_on:
      timescaledb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "--no-check-certificate", "https://localhost:8443/api/v1/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    networks:
      - btc-ml-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"


volumes:
  timescaledb_data:
    driver: local
  pgadmin_data:
    driver: local
  #ml_models:
  #  driver: local

networks:
  btc-ml-network:
    driver: bridge